<html>

<head>
<style>
	body {
	  background-color: #fff;
	  color: #111;
	  margin: 0px;
	  overflow: hidden;
	  font-family: Monospace;
	  font-size: 20px;
	  position: absolute;
	}
  
	#info {
	  position: absolute;
	  top: 0px;
	  width: 100%;
	  padding: 5px;
	  text-align: center;
	  color: #ffff00
	}
</style>
</head>

<body> 
<div id="info"> HW6-4
</div>
<script src="https://threejs.org/build/three.min.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
<script src="https://raw.githack.com/mrdoob/three.js/dev/examples/js/loaders/MTLLoader.js"></script>
<script src="https://raw.githack.com/mrdoob/three.js/dev/examples/js/loaders/OBJLoader.js"></script>

<script id="vs-mosaic" type="x-shader/x-vertex">
  varying vec2 vUv; 
  void main() { 
      gl_Position = projectionMatrix* modelViewMatrix * vec4( position, 1.0); 
      vUv = uv; 
  }
</script>
<script id="fs-mosaic" type="x-shader/x-fragment">
  uniform sampler2D texture; 
  varying vec2 vUv; 
  uniform float gran;
  vec2 vUvm;
  uniform vec2 headNDC;
  uniform float headSize;
  void main() {
    float d = distance (headNDC, vUv);
    float borderWidth = headSize*0.1; 
    if (d < headSize) {
  	  vUvm = floor (vUv/gran)*gran;     
  		gl_FragColor = texture2D(texture, vUvm); 
    } else if (d < headSize+borderWidth) {
       gl_FragColor = vec4(1,0,0,1);
    } else {
      vUvm = vUv;
        	gl_FragColor = texture2D(texture, vUvm); 
    }
   }
/*
void main() {
  gl_FragColor = texture2D (texture, vUv);
}
*/
</script>
<script>
    var scene, renderer, camera,skull,light,chair;
    var material_shh;
    var sceneRTT, cameraRTT;
    var renderTarget;
    var subject;
    var angle = 0;
    init();
    animate();
    function init() {
    renderer = new THREE.WebGLRenderer({
        antialias: true
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    renderer.setClearColor(0x888888);
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(80, window.innerWidth / window.innerHeight, 1, 1000);
    camera.position.y = 40;
    camera.position.z = 150;
    camera.lookAt(new THREE.Vector3(0, 0, 0));
    let controls = new THREE.OrbitControls(camera, renderer.domElement);
    window.addEventListener('resize', onWindowResize, false);
    ///////////////////////////////////////////////////////
    scene0 = new THREE.Scene();
    //scene0.add (new THREE.GridHelper (200,20,'red','white'));
    subject = new THREE.Group();
    //t = new THREE.Mesh (new THREE.CylinderGeometry (8,8,20,38), new THREE.MeshPhongMaterial({color: 'white'}));
    //t.position.y = 45;

    gs = new THREE.Group();
    readModel('gs',100,gs);
    gs.rotation.x-=Math.PI/2;
    gs.rotation.z+=Math.PI/2/1.25;
    gs.position.set(0,65,10);      
    subject.add (gs);
    scene0.add (subject);
        
    renderTarget = new THREE.WebGLRenderTarget(1024,1024);//256,256); 
    
    ///////////////////////////////////////////////////////////////////////
    var uniforms = {
      headNDC: {
      type: 'v2',
      value: null
    },
    headSize: {
     type: 'f',
     value: 0
    },
    texture: {
      type: 't',
      value: renderTarget.texture
    }, 
    gran: {
    	type: 'f',
      value: 0
    }
  };
    var vertShader = document.getElementById('vs-mosaic').innerHTML;
    var fragShader = document.getElementById('fs-mosaic').innerHTML;
        material_shh = new THREE.ShaderMaterial({
        uniforms: uniforms,
        vertexShader: vertShader,
        fragmentShader: fragShader
    });
    plane = new THREE.Mesh (new THREE.PlaneGeometry (100,100), material_shh );
    camera0 = new THREE.OrthographicCamera (-50,50,50,-50,-100,100);  
    scene.add (plane);

            var loader = new THREE.TextureLoader();
            var texture2 = loader.load('https://i.imgur.com/DrvlmNW.jpg');
            loader.crossOrigin = '';
            
			var geometry = new THREE.BoxBufferGeometry(150, 5, 70);
            var material = new THREE.MeshPhongMaterial( {map: texture2} );
            cube = new THREE.Mesh( geometry, material );
            scene0.add( cube );
            cube.position.set(0,35,0);
            var geometry = new THREE.BoxBufferGeometry(5, 40, 5);
            tableleg = new THREE.Mesh(geometry,material);
            tableleg2 = new THREE.Mesh(geometry,material);
            tableleg3 = new THREE.Mesh(geometry,material);
            tableleg4 = new THREE.Mesh(geometry,material);
            tableleg.position.set(-55,15,30);
            tableleg2.position.set(-55,15,-30);
            tableleg3.position.set(55,15,30);
            tableleg4.position.set(55,15,-30);
            scene0.add(tableleg,tableleg2,tableleg3,tableleg4);
            
            light = new THREE.PointLight();
            scene0.add(light);
            light.position.set(0,100,0);
  
            var floor = new THREE.Mesh(new THREE.PlaneGeometry(300, 300),
            new THREE.MeshPhongMaterial({side: THREE.DoubleSide,color: 'grey'}));
            floor.rotation.x = -Math.PI / 2;
            scene0.add(floor);
}
function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}
function readModel (modelName, targetSize, group) {
var onProgress = function(xhr) {
if (xhr.lengthComputable) {
    var percentComplete = xhr.loaded / xhr.total * 100;
    console.log(Math.round(percentComplete, 2) + '% downloaded');
}
};
var onError = function(xhr) {};
var mtlLoader = new THREE.MTLLoader();
mtlLoader.load(modelName+'.mtl', function(materials) {
materials.preload();
var objLoader = new THREE.OBJLoader();
objLoader.setMaterials(materials);
objLoader.load(modelName+'.obj', function(object) {
    
    theObject =  unitize (object, targetSize);
    theObject.name = 'OBJ';
    group.add (theObject);
    
    theObject.setRotationFromEuler (new THREE.Euler (3.1416/2, 0, -3.1416/2, 'ZYX'))
}, onProgress, onError);
});
}
function unitize (object, targetSize) {  
// find bounding box of 'object'
var box3 = new THREE.Box3();
box3.setFromObject (object);
var size = new THREE.Vector3();
size.subVectors (box3.max, box3.min);
var center = new THREE.Vector3();
center.addVectors(box3.max, box3.min).multiplyScalar (0);
console.log ('center: ' + center.x + ', '+center.y + ', '+center.z );
console.log ('size: ' + size.x + ', ' +  size.y + ', '+size.z );
// uniform scaling according to objSize
var objSize = Math.max (size.x, size.y, size.z);
var scaleSet = targetSize/objSize;
        
theObject =  new THREE.Object3D();
theObject.add (object);
object.scale.set (scaleSet, scaleSet, scaleSet);
object.position.set (-center.x*scaleSet, -center.y*scaleSet, -center.z*scaleSet);
theObject.traverse (
function (mesh) {
    if (mesh instanceof THREE.Mesh) {
    mesh.castShadow = true;
        mesh.receiveShadow = true;
    }
}
);

return theObject;
}
function animate() {
  requestAnimationFrame(animate);
  
  angle+=0.01;
  light.position.set (70*Math.cos(angle), 100, 70*Math.sin(angle));
  // compute headNDC
  var headCenter = new THREE.Vector3(0,70,0);
  subject.localToWorld (headCenter);
  var headTop = new THREE.Vector3(0,90,0);
  subject.localToWorld (headTop);
  var headnose = new THREE.Vector3(0,70,10);
  subject.localToWorld(headnose);
  headCenter.applyMatrix4 (camera.matrixWorldInverse).applyMatrix4 (camera.projectionMatrix);
  material_shh.uniforms.headNDC.value = new THREE.Vector2 ((headCenter.x+1)/2, (headCenter.y+1)/2);
  headTop.applyMatrix4 (camera.matrixWorldInverse).applyMatrix4 (camera.projectionMatrix);
  headnose.applyMatrix4 (camera.matrixWorldInverse).applyMatrix4 (camera.projectionMatrix);
  material_shh.uniforms.gran.value = 0.01;
  material_shh.uniforms.headSize.value = 1.2 * headTop.distanceTo(headCenter)/2;
  
  //////////////////// forsomeface
if (headnose.z - headCenter.z > 0) {
    renderer.setRenderTarget (renderTarget);
    renderer.render(scene0, camera);
    renderer.setRenderTarget (null);  
    renderer.render(scene, camera0);
  }  else{
  	renderer.setRenderTarget (null);  
  	renderer.render(scene0, camera);
  
  }
  
  //////////////////// allface
  /*renderer.setRenderTarget (renderTarget);
  renderer.render(scene0, camera);
  
  renderer.setRenderTarget (null);  
  renderer.render(scene, camera0);  
  */

}
</script>
</body>

</html>